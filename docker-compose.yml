services:
  test:
    build:
      context: .
      dockerfile: docker/Dockerfile
    environment:
      - NVIDIA_VISIBLE_DEVICES=all  # Make all GPUs visible
      - NVIDIA_DRIVER_CAPABILITIES=compute,utility  # Enable CUDA and nvidia-smi
      - WANDB_API_KEY=${WANDB_API_KEY:?please specify WANDB_API_KEY}
    volumes:
      - ${MMDETECTION_DATA_DIR:?please specify dataset path}:/mmdetection/data  # Mount data directory
      - ${MMDETECTION_WORK_DIRS:?please specify work directory}:/mmdetection/work_dirs  # Mount work directory for outputs
      - ${MMDETECTION_CONFIGS:-./configs}:/mmdetection/configs  # Mount custom configs
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: all
              capabilities: [gpu]
    shm_size: '32gb'
    command: [
      "python", "tools/test.py", 
      "configs/rtmdet/rtmdet_x_8xb32-300e_coco.py", 
      "/mmdetection/work_dirs/rtmdet_x/rtmdet_x_8xb32-300e_coco_20220715_230555-cc79b9ae.pth",
      "--work-dir", "/mmdetection/work_dirs/rtmdet_x",
      "--out", "/mmdetection/work_dirs/rtmdet_x/results.pkl",
      "--cfg-options", "train_dataloader.dataset.data_root=/mmdetection/data",
      "--cfg-options", "train_dataloader.dataset.ann_file=train.json",
      "--cfg-options", "train_dataloader.dataset.data_prefix.img='data'",
      "--cfg-options", "val_dataloader.dataset.data_root=/mmdetection/data",
      "--cfg-options", "val_dataloader.dataset.ann_file=val.json",
      "--cfg-options", "val_dataloader.dataset.data_prefix.img='data'",
      "--cfg-options", "test_dataloader.batch_size=16",
      "--cfg-options", "test_dataloader.dataset.data_root=/mmdetection/data",
      "--cfg-options", "test_dataloader.dataset.ann_file=val.json",
      "--cfg-options", "test_dataloader.dataset.data_prefix.img='data'",
      "--cfg-options", "val_evaluator.ann_file='/mmdetection/data/val.json'",
      "--cfg-options", "test_evaluator.ann_file='/mmdetection/data/val.json'",
    ]
