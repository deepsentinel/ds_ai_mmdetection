services:
  test:
    build:
      context: .
      dockerfile: docker/Dockerfile
    environment:
      - NVIDIA_VISIBLE_DEVICES=all  # Make all GPUs visible
      - NVIDIA_DRIVER_CAPABILITIES=compute,utility  # Enable CUDA and nvidia-smi
      - WANDB_API_KEY=${WANDB_API_KEY:?please specify WANDB_API_KEY}
    volumes:
      - ${MMDETECTION_DATA_DIR:?please specify dataset path}:/mmdetection/data  # Mount data directory
      - ${MMDETECTION_WORK_DIRS:?please specify work directory}:/mmdetection/work_dirs  # Mount work directory for outputs
      - ${MMDETECTION_CONFIGS:-./configs}:/mmdetection/configs  # Mount custom configs
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: all
              capabilities: [gpu]
    shm_size: '32gb'
    command: [
      "python", "tools/test.py", 
      "projects/CO-DETR/configs/codino/co_dino_5scale_swin_l_16xb1_16e_o365tococo.py", 
      "/mmdetection/work_dirs/co_detr_swin_l/mscoco.pth",
      "--work-dir", "/mmdetection/work_dirs/co_detr_swin_l",
      "--cfg-options", 
      "test_dataloader.batch_size=2",
      "test_dataloader.dataset.data_root=/mmdetection/data",
      "test_dataloader.dataset.ann_file=val.json",
      "test_dataloader.dataset.data_prefix.img='data'",
      "test_evaluator.ann_file='/mmdetection/data/val.json'",
      "test_evaluator.classwise=True"
    ]
